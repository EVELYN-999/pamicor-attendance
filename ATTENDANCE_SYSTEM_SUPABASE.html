<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pamicor Attendance System - Cloud Edition</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React, Icons, and Supabase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>

    <!-- Application Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        .font-script { font-family: 'Dancing Script', cursive; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        
        /* FIX: Hide default browser time picker icon */
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        @media print {
            @page { margin: 0.5cm; }
            body { -webkit-print-color-adjust: exact; background-color: white; }
            .print\:hidden { display: none !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:w-full { width: 100% !important; }
            .print\:overflow-visible { overflow: visible !important; }
            .print\:flex { display: flex !important; }
            aside { display: none; }
        }
        
        /* UPDATED: Custom Scrollbar - Wider and Darker for easy manipulation */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 6px; border: 2px solid #e2e8f0; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Connection Status Indicator */
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .connection-online { background-color: #10b981; }
        .connection-offline { background-color: #ef4444; }
        .connection-syncing { background-color: #f59e0b; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>

    <!-- Babel for JSX processing in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Save, Clock, MapPin, User, FileText, CheckSquare, 
            Printer, Search, ChevronLeft, Briefcase, PenTool, History, 
            FileSpreadsheet, Download, Users, X, Check, Lock, LogOut, 
            ShieldCheck, KeyRound, ChevronDown, UserPlus, ArrowLeft, AlertCircle, 
            RotateCcw, Sun, Moon, Sunset, HardDrive, Upload, Wifi, WifiOff, 
            RefreshCw, Database, Cloud, QrCode
        } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- Supabase Configuration ---
        // REPLACE THESE WITH YOUR ACTUAL SUPABASE CREDENTIALS
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
        
        // Initialize Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Constants ---
        const COMPANY_OPTIONS = ['Pamicor', 'Visitor', 'Contractor', 'WTP'];
        const JOB_TITLE_OPTIONS = [
            'IT', 'HSE', 'HR', 'Finance', 'Maintenance', 'Logistics', 
            'Mechanical Workshop', 'Electrical Workshop', 'Plant', 'Control Room', 'Lab',
            'Trainee', 'Intern', 'Visitor'
        ];

        // TIMELINE CONFIGURATION (Automatic Time Limits)
        const TIMELINES = {
            'Morning': { start: '07:00', end: '08:00', icon: <Sun size={14} className="mr-1 text-orange-500"/> },
            'Afternoon': { start: '13:00', end: '14:00', icon: <Sun size={14} className="mr-1 text-yellow-500"/> },
            'Evening': { start: '18:00', end: '19:00', icon: <Moon size={14} className="mr-1 text-indigo-500"/> }
        };

        // --- Utility Functions ---
        const generateId = () => crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substr(2, 9);
        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        };
        const calculateDuration = (start, end) => {
            if (!start || !end) return '';
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            let diffInMinutes = (endH * 60 + endM) - (startH * 60 + startM);
            if (diffInMinutes < 0) diffInMinutes += 24 * 60;
            const hours = Math.floor(diffInMinutes / 60);
            const minutes = diffInMinutes % 60;
            if (hours > 0 && minutes > 0) return `${hours} hr ${minutes} min`;
            if (hours > 0) return `${hours} hr`;
            return `${minutes} min`;
        };
        
        // Late Check Logic
        const checkIsLate = (signTimeStr, meetingStartTimeStr) => {
            if (!signTimeStr || !meetingStartTimeStr) return false;
            const [startH, startM] = meetingStartTimeStr.split(':').map(Number);
            const meetingMinutes = startH * 60 + startM;
            const [signH, signM] = signTimeStr.split(':').map(Number);
            const signMinutes = signH * 60 + signM;
            return signMinutes > meetingMinutes;
        };

        // Detect Current Session based on Real Time
        const getAutoSession = () => {
            const hour = new Date().getHours();
            if (hour < 12) return 'Morning';
            if (hour < 17) return 'Afternoon';
            return 'Evening';
        };

        // QR Code Generation
        const generateQRCode = (meetingId) => {
            const attendUrl = `${window.location.origin}/attend/${meetingId}`;
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(attendUrl)}`;
        };

        // --- Supabase Service Functions ---
        class SupabaseService {
            static async saveMeeting(meetingData) {
                try {
                    const { attendees, ...meeting } = meetingData;
                    
                    // Insert meeting
                    const { data: savedMeeting, error: meetingError } = await supabase
                        .from('meetings')
                        .upsert({
                            id: meeting.id,
                            meeting_name: meeting.meetingName,
                            topic: meeting.topic,
                            date: meeting.date,
                            session: meeting.session,
                            start_time: meeting.startTime,
                            end_time: meeting.endTime,
                            duration: meeting.duration,
                            type: meeting.type,
                            site: meeting.site,
                            conducted_by: meeting.conductedBy,
                            conductor_signature: meeting.conductorSignature || false,
                            conductor_sign_time: meeting.conductorSignTime || null,
                            minutes: meeting.minutes || ''
                        })
                        .select()
                        .single();

                    if (meetingError) throw meetingError;

                    // Delete existing attendees and insert new ones
                    await supabase.from('attendees').delete().eq('meeting_id', meeting.id);
                    
                    if (attendees && attendees.length > 0) {
                        const validAttendees = attendees.filter(att => att.name && att.name.trim() !== '');
                        if (validAttendees.length > 0) {
                            const attendeesData = validAttendees.map(att => ({
                                id: att.id,
                                meeting_id: savedMeeting.id,
                                name: att.name,
                                company: att.company,
                                job_title: att.jobTitle,
                                signature: att.signature || false,
                                sign_time: att.signTime || null,
                                is_late: checkIsLate(att.signTime, meeting.startTime)
                            }));

                            const { error: attendeesError } = await supabase
                                .from('attendees')
                                .upsert(attendeesData);

                            if (attendeesError) throw attendeesError;
                        }
                    }

                    return { success: true, data: savedMeeting };
                } catch (error) {
                    console.error('Error saving meeting:', error);
                    return { success: false, error: error.message };
                }
            }

            static async loadAllMeetings() {
                try {
                    const { data: meetings, error: meetingsError } = await supabase
                        .from('meetings')
                        .select(`
                            *,
                            attendees (*)
                        `)
                        .order('created_at', { ascending: false });

                    if (meetingsError) throw meetingsError;

                    // Transform data to match your current format
                    const transformedMeetings = meetings.map(meeting => ({
                        id: meeting.id,
                        meetingName: meeting.meeting_name,
                        topic: meeting.topic,
                        date: meeting.date,
                        session: meeting.session,
                        startTime: meeting.start_time,
                        endTime: meeting.end_time,
                        duration: meeting.duration,
                        type: meeting.type,
                        site: meeting.site,
                        conductedBy: meeting.conducted_by,
                        conductorSignature: meeting.conductor_signature,
                        conductorSignTime: meeting.conductor_sign_time,
                        minutes: meeting.minutes || '',
                        createdAt: meeting.created_at,
                        updatedAt: meeting.updated_at,
                        attendees: meeting.attendees.map(att => ({
                            id: att.id,
                            name: att.name,
                            company: att.company,
                            jobTitle: att.job_title,
                            signature: att.signature,
                            signTime: att.sign_time,
                            isLate: att.is_late
                        }))
                    }));

                    return { success: true, data: transformedMeetings };
                } catch (error) {
                    console.error('Error loading meetings:', error);
                    return { success: false, error: error.message };
                }
            }

            static async deleteMeeting(meetingId) {
                try {
                    const { error } = await supabase
                        .from('meetings')
                        .delete()
                        .eq('id', meetingId);

                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting meeting:', error);
                    return { success: false, error: error.message };
                }
            }

            static async testConnection() {
                try {
                    const { data, error } = await supabase.from('meetings').select('count').limit(1);
                    return { success: !error, error: error?.message };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        // --- Export Functions ---
        const downloadCSV = (content, filename) => {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const generateSheetCSV = (sheet) => {
            const validAttendees = sheet.attendees.filter(att => att.name && att.name.trim() !== '');
            const sortedAttendees = [...validAttendees].sort((a, b) => {
                if (!a.signTime) return 1;
                if (!b.signTime) return -1;
                return a.signTime.localeCompare(b.signTime);
            });
            const metaHeaders = ['Meeting Name', 'Topic', 'Date', 'Timeline', 'Time', 'Duration', 'Type', 'Site', 'Conducted By', 'Conductor Signed', 'Conductor Sign Time'];
            const metaRow = [`"${sheet.meetingName || ''}"`, `"${sheet.topic}"`, sheet.date, sheet.session || 'Morning', `${sheet.startTime} - ${sheet.endTime}`, `"${sheet.duration || ''}"`, sheet.type, `"${sheet.site}"`, `"${sheet.conductedBy}"`, sheet.conductorSignature ? 'Yes' : 'No', sheet.conductorSignTime || ''];
            const attendeeHeaders = ['No.', 'Attendee Name', 'Company', 'Job Title', 'Signed?', 'Sign Time', 'Status'];
            const attendeeRows = sortedAttendees.map((att, index) => {
                const isLate = checkIsLate(att.signTime, sheet.startTime);
                return [
                    index + 1, `"${att.name}"`, `"${att.company}"`, `"${att.jobTitle}"`, att.signature ? 'Yes (Digital)' : 'No', att.signTime || '', isLate ? 'LATE' : 'On Time'
                ];
            });
            return [metaHeaders.join(','), metaRow.join(','), '', attendeeHeaders.join(','), ...attendeeRows.map(r => r.join(','))].join('\n');
        };

        const generateMasterCSV = (sheets) => {
            const headers = ['Date', 'Timeline', 'Meeting Name', 'Meeting Start', 'Meeting End', 'Duration', 'Meeting Type', 'Topic', 'Site', 'Conducted By', 'Conductor Signed', 'Attendee Name', 'Company', 'Job Title', 'Attendee Signed', 'Sign Time', 'Status'];
            let allRows = [];
            sheets.forEach(sheet => {
                sheet.attendees.filter(att => att.name && att.name.trim() !== '').forEach(att => {
                    const isLate = checkIsLate(att.signTime, sheet.startTime);
                    allRows.push({
                        date: sheet.date, session: sheet.session || 'Morning', meetingName: sheet.meetingName || '', startTime: sheet.startTime, endTime: sheet.endTime, duration: sheet.duration || '', type: sheet.type, topic: sheet.topic, site: sheet.site, conductedBy: sheet.conductedBy, conductorSigned: sheet.conductorSignature ? 'Yes' : 'No',
                        name: att.name, company: att.company, jobTitle: att.jobTitle, signed: att.signature ? 'Yes' : 'No', signTime: att.signTime || '', status: isLate ? 'LATE' : 'On Time', sortKey: new Date(`${sheet.date}T${att.signTime || '23:59'}`).getTime()
                    });
                });
            });
            allRows.sort((a, b) => a.sortKey - b.sortKey);
            const csvRows = allRows.map(r => [r.date, r.session, `"${r.meetingName}"`, r.startTime, r.endTime, `"${r.duration}"`, r.type, `"${r.topic}"`, `"${r.site}"`, `"${r.conductedBy}"`, r.conductorSigned, `"${r.name}"`, `"${r.company}"`, `"${r.jobTitle}"`, r.signed, r.signTime, r.status]);
            return [headers.join(','), ...csvRows.map(r => r.join(','))].join('\n');
        };

        // --- Connection Status Component ---
        const ConnectionStatus = ({ status, onRetry }) => {
            const statusConfig = {
                online: { color: 'connection-online', text: 'Online', icon: <Wifi size={12} /> },
                offline: { color: 'connection-offline', text: 'Offline', icon: <WifiOff size={12} /> },
                syncing: { color: 'connection-syncing', text: 'Syncing', icon: <RefreshCw size={12} className="animate-spin" /> }
            };

            const config = statusConfig[status] || statusConfig.offline;

            return (
                <div className="flex items-center space-x-2 text-xs">
                    <div className={`connection-dot ${config.color}`}></div>
                    <span className="text-gray-600">{config.text}</span>
                    {config.icon}
                    {status === 'offline' && (
                        <button onClick={onRetry} className="text-blue-600 hover:text-blue-800 ml-2">
                            <RefreshCw size={12} />
                        </button>
                    )}
                </div>
            );
        };

        // --- QR Code Modal Component ---
        const QRCodeModal = ({ meetingId, meetingName, onClose }) => {
            const qrCodeUrl = generateQRCode(meetingId);
            const attendUrl = `${window.location.origin}/attend/${meetingId}`;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-900 text-white rounded-t-lg">
                            <h3 className="font-bold flex items-center">
                                <QrCode className="mr-2" size={20}/> QR Code for Attendance
                            </h3>
                            <button onClick={onClose} className="text-blue-200 hover:text-white">
                                <X size={20}/>
                            </button>
                        </div>
                        <div className="p-6 text-center">
                            <h4 className="font-bold text-gray-800 mb-2">{meetingName || 'Meeting Attendance'}</h4>
                            <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                <img src={qrCodeUrl} alt="QR Code" className="mx-auto mb-2" />
                                <p className="text-xs text-gray-600">Scan to join attendance</p>
                            </div>
                            <div className="text-left bg-gray-100 p-3 rounded text-xs">
                                <p className="font-bold mb-1">Direct Link:</p>
                                <p className="break-all text-blue-600">{attendUrl}</p>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg">
                            <button onClick={onClose} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Keep all your existing components (SignaturePad, QuickAddModal, LoginScreen, AttendeeForm, Toast)
        // ... [Previous components remain the same] ...

        // --- Main App with Supabase Integration ---
        const PamicorAttendanceSystem = () => {
            const [view, setView] = useState('login');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [activeSheetId, setActiveSheetId] = useState(null);
            const [signingState, setSigningState] = useState({ isOpen: false, type: null, attendeeId: null });
            const [quickAddOpen, setQuickAddOpen] = useState(false);
            const [qrCodeOpen, setQrCodeOpen] = useState(false);
            const [showToast, setShowToast] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('offline');
            const [sheets, setSheets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            // ADMIN LIVE CLOCK
            const [adminTime, setAdminTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setAdminTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Test connection and load data on startup
            useEffect(() => {
                const initializeApp = async () => {
                    setIsLoading(true);
                    const connectionTest = await SupabaseService.testConnection();
                    
                    if (connectionTest.success) {
                        setConnectionStatus('online');
                        const result = await SupabaseService.loadAllMeetings();
                        if (result.success) {
                            setSheets(result.data);
                        } else {
                            console.error('Failed to load meetings:', result.error);
                            // Fallback to localStorage
                            const saved = localStorage.getItem('pamicor_sheets_v2');
                            if (saved) setSheets(JSON.parse(saved));
                        }
                    } else {
                        setConnectionStatus('offline');
                        // Load from localStorage when offline
                        const saved = localStorage.getItem('pamicor_sheets_v2');
                        if (saved) setSheets(JSON.parse(saved));
                    }
                    setIsLoading(false);
                };

                initializeApp();
            }, []);

            // Auto-save to Supabase when sheets change
            useEffect(() => {
                if (sheets.length > 0 && connectionStatus === 'online') {
                    // Save to localStorage immediately
                    localStorage.setItem('pamicor_sheets_v2', JSON.stringify(sheets));
                    
                    // Debounced save to Supabase
                    const saveTimer = setTimeout(async () => {
                        setConnectionStatus('syncing');
                        // Save the most recently updated sheet
                        const recentSheet = sheets.reduce((latest, current) => {
                            const latestTime = new Date(latest.updatedAt || latest.createdAt).getTime();
                            const currentTime = new Date(current.updatedAt || current.createdAt).getTime();
                            return currentTime > latestTime ? current : latest;
                        });
                        
                        const result = await SupabaseService.saveMeeting(recentSheet);
                        setConnectionStatus(result.success ? 'online' : 'offline');
                    }, 2000);

                    return () => clearTimeout(saveTimer);
                }
            }, [sheets, connectionStatus]);

            const retryConnection = async () => {
                setConnectionStatus('syncing');
                const connectionTest = await SupabaseService.testConnection();
                
                if (connectionTest.success) {
                    setConnectionStatus('online');
                    const result = await SupabaseService.loadAllMeetings();
                    if (result.success) {
                        setSheets(result.data);
                    }
                } else {
                    setConnectionStatus('offline');
                }
            };

            const createNewSheet = () => {
                const autoSession = getAutoSession();
                const defaultTimes = TIMELINES[autoSession];

                const newSheet = {
                    id: generateId(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    type: 'Meeting',
                    topic: '',
                    meetingName: '',
                    date: new Date().toISOString().split('T')[0],
                    session: autoSession,
                    startTime: defaultTimes.start,
                    endTime: defaultTimes.end,
                    duration: calculateDuration(defaultTimes.start, defaultTimes.end),
                    site: '',
                    conductedBy: '',
                    conductorSignature: null,
                    conductorSignTime: null,
                    attendees: Array(5).fill(null).map(() => ({
                        id: generateId(),
                        name: '',
                        company: 'Pamicor',
                        jobTitle: '',
                        signature: null,
                        signTime: null
                    })),
                    minutes: ''
                };
                setSheets([newSheet, ...sheets]);
                setActiveSheetId(newSheet.id);
            };

            const updateSheet = (id, field, value) => {
                setSheets(sheets.map(sheet => {
                    if (sheet.id !== id) return sheet;
                    const updated = { ...sheet, [field]: value };
                    
                    if (field === 'session') {
                        const newTimes = TIMELINES[value];
                        if (newTimes) {
                            updated.startTime = newTimes.start;
                            updated.endTime = newTimes.end;
                            updated.duration = calculateDuration(newTimes.start, newTimes.end);
                        }
                    }
                    
                    if (field === 'startTime' || field === 'endTime') {
                        updated.duration = calculateDuration(updated.startTime, updated.endTime);
                    }
                    
                    updated.updatedAt = new Date().toISOString();
                    return updated;
                }));
            };

            const deleteSheet = async (id, e) => {
                e.stopPropagation();
                if (confirm('Delete this record? This will also delete it from the cloud database.')) {
                    // Delete from Supabase if online
                    if (connectionStatus === 'online') {
                        await SupabaseService.deleteMeeting(id);
                    }
                    
                    setSheets(sheets.filter(s => s.id !== id));
                    if (activeSheetId === id) setActiveSheetId(null);
                }
            };

            const activeSheet = sheets.find(s => s.id === activeSheetId);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading attendance system...</p>
                        </div>
                    </div>
                );
            }

            if (view === 'login') {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
                            <div className="bg-blue-900 p-8 text-center">
                                <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white mb-4 shadow-lg">
                                    <ShieldCheck size={32} className="text-blue-900" />
                                </div>
                                <h1 className="text-2xl font-bold text-white">PAMICOR</h1>
                                <p className="text-blue-200 text-sm">Cloud Attendance System</p>
                                <div className="mt-4">
                                    <ConnectionStatus status={connectionStatus} onRetry={retryConnection} />
                                </div>
                            </div>
                            <div className="p-8">
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const username = e.target.username.value;
                                    const password = e.target.password.value;
                                    if (username.toLowerCase() === 'admin' && password === 'Rich@0322') {
                                        setCurrentUser(username);
                                        setView('admin');
                                    } else {
                                        alert('Invalid credentials');
                                    }
                                }} className="mb-6 pb-6 border-b border-gray-100">
                                    <div className="mb-4">
                                        <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center">
                                            <User size={16} className="mr-2 text-gray-400" /> Username
                                        </label>
                                        <input name="username" type="text" className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter username" />
                                    </div>
                                    <div className="mb-4">
                                        <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center">
                                            <KeyRound size={16} className="mr-2 text-gray-400" /> Password
                                        </label>
                                        <input name="password" type="password" className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter password" />
                                    </div>
                                    <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded hover:bg-blue-700 flex justify-center items-center transition-colors">
                                        <Lock size={18} className="mr-2" /> Login as Admin
                                    </button>
                                </form>
                                
                                <div className="text-center">
                                    <p className="text-sm text-gray-500 mb-3">Just marking attendance?</p>
                                    <button onClick={() => setView('attendee')} className="w-full bg-white border-2 border-blue-600 text-blue-600 font-bold py-3 px-4 rounded hover:bg-blue-50 flex justify-center items-center transition-colors">
                                        <UserPlus size={18} className="mr-2" /> Add My Attendance
                                    </button>
                                </div>
                            </div>
                            <div className="bg-gray-50 p-3 text-center border-t border-gray-100">
                                <p className="text-[10px] text-gray-400">Cloud-Powered • Real-time Sync • 24/7 Access</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main admin interface with cloud features
            return (
                <div className="min-h-screen bg-gray-100 flex overflow-hidden font-sans">
                    {showToast && <div className="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center toast-enter z-50">
                        <Check size={20} className="mr-2" />
                        <span className="font-medium">Saved to Cloud</span>
                    </div>}
                    
                    {qrCodeOpen && activeSheet && (
                        <QRCodeModal 
                            meetingId={activeSheet.id} 
                            meetingName={activeSheet.meetingName || activeSheet.topic} 
                            onClose={() => setQrCodeOpen(false)} 
                        />
                    )}
                    
                    <aside className={`${sidebarOpen ? 'w-80' : 'w-0'} bg-white border-r border-gray-200 flex flex-col fixed md:relative h-full z-20 transition-all print:hidden`}>
                        <div className="p-4 border-b flex justify-between bg-gray-50">
                            <h2 className="font-bold text-gray-700 flex items-center">
                                <Cloud size={18} className="mr-2"/> Cloud Records
                            </h2>
                            <div className="flex items-center space-x-2">
                                <ConnectionStatus status={connectionStatus} onRetry={retryConnection} />
                                <button onClick={() => setSidebarOpen(false)} className="md:hidden text-gray-500">
                                    <ChevronLeft/>
                                </button>
                            </div>
                        </div>
                        <div className="p-3">
                            <button onClick={createNewSheet} className="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md flex items-center justify-center text-sm font-medium mb-4">
                                <Plus size={16} className="mr-1" /> New Sheet
                            </button>
                            <div className="space-y-2 overflow-y-auto h-[calc(100vh-180px)]">
                                {sheets.map(sheet => (
                                    <div key={sheet.id} onClick={() => setActiveSheetId(sheet.id)} className={`p-3 rounded-lg border cursor-pointer transition-all relative group ${activeSheetId === sheet.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-100'}`}>
                                        <div className="flex justify-between mb-1">
                                            <span className="text-xs font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded">{sheet.type}</span>
                                            <span className="text-xs text-gray-400">{formatDate(sheet.date)}</span>
                                        </div>
                                        <h3 className="text-sm font-medium text-gray-800 truncate mb-1">{sheet.meetingName || sheet.topic || 'Untitled'}</h3>
                                        <div className="text-xs text-gray-500 flex items-center">
                                            <MapPin size={10} className="mr-1"/> {sheet.site}
                                        </div>
                                        <button onClick={(e) => deleteSheet(sheet.id, e)} className="absolute right-2 bottom-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100">
                                            <Trash2 size={14} />
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="absolute bottom-0 left-0 w-full p-3 bg-gray-50 border-t">
                                <button onClick={() => sheets.length ? downloadCSV(generateMasterCSV(sheets), `Master_Report_${new Date().toISOString().split('T')[0]}.csv`) : alert('No records')} className="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded">
                                    <FileSpreadsheet size={14} className="mr-2" /> Export All Data
                                </button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-grow flex flex-col h-screen overflow-hidden w-full">
                        <header className="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm print:hidden">
                            <div className="flex items-center">
                                {!sidebarOpen && <button onClick={() => setSidebarOpen(true)} className="mr-4 text-gray-500"><Search size={20} /></button>}
                                <h1 className="text-xl font-bold text-gray-800">
                                    <span className="text-blue-900 mr-2">PAMICOR</span> 
                                    <span className="text-sm text-gray-600 font-normal">| Cloud Attendance</span>
                                </h1>
                            </div>
                            <div className="flex items-center space-x-2">
                                <div className="hidden md:block mr-4 text-right">
                                    <div className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">System Time</div>
                                    <div className="text-sm font-mono font-bold text-gray-700">{adminTime.toLocaleTimeString('en-GB')}</div>
                                </div>
                                {activeSheet && (
                                    <button onClick={() => setQrCodeOpen(true)} className="flex items-center bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-2 rounded transition-colors border border-purple-200 mr-2" title="Generate QR Code">
                                        <QrCode size={18} className="mr-2"/> QR
                                    </button>
                                )}
                                <button onClick={() => setShowToast(true)} className="flex items-center bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded transition-colors border border-blue-200 mr-2" title="Save to Cloud">
                                    <Database size={18} className="mr-2"/> <span className="hidden md:inline">Save</span>
                                </button>
                                {activeSheet && <button onClick={() => downloadCSV(generateSheetCSV(activeSheet), `Attendance_${activeSheet.date}.csv`)} className="flex items-center text-gray-600 hover:text-green-600 px-3 py-2 rounded hover:bg-green-50">
                                    <Download size={18} className="mr-2"/> Export
                                </button>}
                                <button onClick={() => window.print()} className="flex items-center text-gray-600 hover:text-blue-600 px-3 py-2 rounded hover:bg-blue-50">
                                    <Printer size={18} className="mr-2"/> Print
                                </button>
                                <div className="h-6 w-px bg-gray-300 mx-2"></div>
                                <button onClick={() => { setView('login'); setCurrentUser(null); setActiveSheetId(null); }} className="flex items-center text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50">
                                    <LogOut size={18} />
                                </button>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto bg-gray-100 p-4 md:p-8 print:p-0 print:bg-white">
                            {!activeSheet ? (
                                <div className="flex h-full flex-col items-center justify-center">
                                    <div className="text-center max-w-md">
                                        <div className="bg-blue-900 text-white p-4 rounded-full inline-block mb-4">
                                            <Cloud size={48} />
                                        </div>
                                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Welcome, {currentUser}</h1>
                                        <p className="text-gray-600 mb-4">Your data is automatically saved to the cloud and accessible 24/7</p>
                                        <button onClick={createNewSheet} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                                            Start New Attendance Sheet
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-none md:rounded-lg overflow-hidden print:shadow-none print:w-full">
                                    {/* Your existing sheet interface remains the same */}
                                    <div className="p-8 border-b-2 border-gray-800">
                                        <div className="text-center mb-6 print:hidden">
                                            <h2 className="text-2xl font-black text-gray-900 uppercase tracking-widest border-b-4 border-double border-gray-800 inline-block pb-1">
                                                Cloud Attendance Sheet
                                            </h2>
                                        </div>
                                        {/* Rest of your sheet interface... */}
                                        <p className="text-center text-xs text-gray-500 mb-4">
                                            Auto-saved to cloud • Real-time sync • ID: {activeSheet.id.slice(0, 8)}
                                        </p>
                                        {/* ... rest of your existing sheet content ... */}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<PamicorAttendanceSystem />);
    </script>
</body>
</html>