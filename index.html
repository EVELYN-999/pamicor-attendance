<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pamicor Attendance System</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React, Icons, and Supabase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>

    <!-- Application Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        .font-script { font-family: 'Dancing Script', cursive; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        
        /* FIX: Hide default browser time picker icon */
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        @media print {
            @page { margin: 0.5cm; }
            body { -webkit-print-color-adjust: exact; background-color: white; }
            .print\:hidden { display: none !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:w-full { width: 100% !important; }
            .print\:overflow-visible { overflow: visible !important; }
            .print\:flex { display: flex !important; }
            aside { display: none; }
        }
        
        /* UPDATED: Custom Scrollbar - Wider and Darker for easy manipulation */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 6px; border: 2px solid #e2e8f0; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        
        /* Connection Status Indicator */
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .connection-online { background-color: #10b981; }
        .connection-offline { background-color: #ef4444; }
        .connection-syncing { background-color: #f59e0b; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>

    <!-- Babel for JSX processing in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Save, Clock, MapPin, User, FileText, CheckSquare, 
            Printer, Search, ChevronLeft, Briefcase, PenTool, History, 
            FileSpreadsheet, Download, Users, X, Check, Lock, LogOut, 
            ShieldCheck, KeyRound, ChevronDown, UserPlus, ArrowLeft, AlertCircle, 
            RotateCcw, Sun, Moon, Sunset, HardDrive, Upload, Wifi, WifiOff, 
            RefreshCw, Database, Cloud, QrCode, BookOpen, Play, HelpCircle
        } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://zimvcbngrmriybspkazh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppbXZjYm5ncm1yaXlic3BrYXpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY5NzEsImV4cCI6MjA3OTg0Mjk3MX0.TzNkLZaQo9USwGzNRKH00hjV2hcLy-9ZZ0RhKe7zvoU';
        
        // Initialize Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Constants ---
        const COMPANY_OPTIONS = ['Pamicor', 'Visitor', 'Contractor', 'WTP'];
        const JOB_TITLE_OPTIONS = [
            'IT', 'HSE', 'HR', 'Finance', 'Maintenance', 'Logistics', 
            'Mechanical Workshop', 'Electrical Workshop', 'Plant', 'Control Room', 'Lab',
            'Trainee', 'Intern', 'Visitor'
        ];

        // TIMELINE CONFIGURATION (Automatic Time Limits - 45 minutes)
        const TIMELINES = {
            'Morning': { start: '07:00', end: '07:45', icon: <Sun size={14} className="mr-1 text-orange-500"/> },
            'Afternoon': { start: '13:00', end: '13:45', icon: <Sun size={14} className="mr-1 text-yellow-500"/> },
            'Evening': { start: '18:00', end: '18:45', icon: <Moon size={14} className="mr-1 text-indigo-500"/> }
        };

        // --- Utility Functions ---
        const generateId = () => crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substr(2, 9);
        
        // QR Code Generation
        const generateQRCode = (meetingId) => {
            const attendUrl = `${window.location.origin}/attend/${meetingId}`;
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(attendUrl)}`;
        };

        // --- Supabase Service Functions ---
        class SupabaseService {
            static async saveMeeting(meetingData) {
                try {
                    const { attendees, ...meeting } = meetingData;
                    
                    // Insert meeting
                    const { data: savedMeeting, error: meetingError } = await supabase
                        .from('meetings')
                        .upsert({
                            id: meeting.id,
                            meeting_name: meeting.meetingName,
                            topic: meeting.topic,
                            date: meeting.date,
                            session: meeting.session,
                            start_time: meeting.startTime,
                            end_time: meeting.endTime,
                            duration: meeting.duration,
                            type: meeting.type,
                            site: meeting.site,
                            conducted_by: meeting.conductedBy,
                            conductor_signature: meeting.conductorSignature || false,
                            conductor_sign_time: meeting.conductorSignTime || null,
                            minutes: meeting.minutes || ''
                        })
                        .select()
                        .single();

                    if (meetingError) throw meetingError;

                    // Delete existing attendees and insert new ones
                    await supabase.from('attendees').delete().eq('meeting_id', meeting.id);
                    
                    if (attendees && attendees.length > 0) {
                        const validAttendees = attendees.filter(att => att.name && att.name.trim() !== '');
                        if (validAttendees.length > 0) {
                            const attendeesData = validAttendees.map(att => ({
                                id: att.id,
                                meeting_id: savedMeeting.id,
                                name: att.name,
                                company: att.company,
                                job_title: att.jobTitle,
                                signature: att.signature || false,
                                sign_time: att.signTime || null,
                                is_late: checkIsLate(att.signTime, meeting.startTime)
                            }));

                            const { error: attendeesError } = await supabase
                                .from('attendees')
                                .upsert(attendeesData);

                            if (attendeesError) throw attendeesError;
                        }
                    }

                    return { success: true, data: savedMeeting };
                } catch (error) {
                    console.error('Error saving meeting:', error);
                    return { success: false, error: error.message };
                }
            }

            static async loadAllMeetings() {
                try {
                    const { data: meetings, error: meetingsError } = await supabase
                        .from('meetings')
                        .select(`
                            *,
                            attendees (*)
                        `)
                        .order('created_at', { ascending: false });

                    if (meetingsError) throw meetingsError;

                    // Transform data to match your current format
                    const transformedMeetings = meetings.map(meeting => ({
                        id: meeting.id,
                        meetingName: meeting.meeting_name,
                        topic: meeting.topic,
                        date: meeting.date,
                        session: meeting.session,
                        startTime: meeting.start_time,
                        endTime: meeting.end_time,
                        duration: meeting.duration,
                        type: meeting.type,
                        site: meeting.site,
                        conductedBy: meeting.conducted_by,
                        conductorSignature: meeting.conductor_signature,
                        conductorSignTime: meeting.conductor_sign_time,
                        minutes: meeting.minutes || '',
                        createdAt: meeting.created_at,
                        updatedAt: meeting.updated_at,
                        attendees: meeting.attendees.map(att => ({
                            id: att.id,
                            name: att.name,
                            company: att.company,
                            jobTitle: att.job_title,
                            signature: att.signature,
                            signTime: att.sign_time,
                            isLate: att.is_late
                        }))
                    }));

                    return { success: true, data: transformedMeetings };
                } catch (error) {
                    console.error('Error loading meetings:', error);
                    return { success: false, error: error.message };
                }
            }

            static async deleteMeeting(meetingId) {
                try {
                    const { error } = await supabase
                        .from('meetings')
                        .delete()
                        .eq('id', meetingId);

                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting meeting:', error);
                    return { success: false, error: error.message };
                }
            }

            static async testConnection() {
                try {
                    const { data, error } = await supabase.from('meetings').select('count').limit(1);
                    return { success: !error, error: error?.message };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }
        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        };
        const calculateDuration = (start, end) => {
            if (!start || !end) return '';
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            let diffInMinutes = (endH * 60 + endM) - (startH * 60 + startM);
            if (diffInMinutes < 0) diffInMinutes += 24 * 60;
            const hours = Math.floor(diffInMinutes / 60);
            const minutes = diffInMinutes % 60;
            if (hours > 0 && minutes > 0) return `${hours} hr ${minutes} min`;
            if (hours > 0) return `${hours} hr`;
            return `${minutes} min`;
        };
        
        // Late Check Logic
        const checkIsLate = (signTimeStr, meetingStartTimeStr) => {
            if (!signTimeStr || !meetingStartTimeStr) return false;
            const [startH, startM] = meetingStartTimeStr.split(':').map(Number);
            const meetingMinutes = startH * 60 + startM;
            // Sign time is usually "HH:mm:ss" or "HH:mm", we need "HH:mm"
            const [signH, signM] = signTimeStr.split(':').map(Number);
            const signMinutes = signH * 60 + signM;
            return signMinutes > meetingMinutes;
        };

        // Detect Current Session based on Real Time
        const getAutoSession = () => {
            const hour = new Date().getHours();
            if (hour < 12) return 'Morning';
            if (hour < 17) return 'Afternoon';
            return 'Evening';
        };

        // --- Export Functions ---
        const downloadCSV = (content, filename) => {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const generateSheetCSV = (sheet) => {
            const validAttendees = sheet.attendees.filter(att => att.name && att.name.trim() !== '');
            const sortedAttendees = [...validAttendees].sort((a, b) => {
                if (!a.signTime) return 1;
                if (!b.signTime) return -1;
                return a.signTime.localeCompare(b.signTime);
            });
            const metaHeaders = ['Meeting Name', 'Topic', 'Date', 'Timeline', 'Time', 'Duration', 'Type', 'Site', 'Conducted By', 'Conductor Signed', 'Conductor Sign Time'];
            const metaRow = [`"${sheet.meetingName || ''}"`, `"${sheet.topic}"`, sheet.date, sheet.session || 'Morning', `${sheet.startTime} - ${sheet.endTime}`, `"${sheet.duration || ''}"`, sheet.type, `"${sheet.site}"`, `"${sheet.conductedBy}"`, sheet.conductorSignature ? 'Yes' : 'No', sheet.conductorSignTime || ''];
            const attendeeHeaders = ['No.', 'Attendee Name', 'Company', 'Job Title', 'Signed?', 'Sign Time', 'Status'];
            const attendeeRows = sortedAttendees.map((att, index) => {
                const isLate = checkIsLate(att.signTime, sheet.startTime);
                return [
                    index + 1, `"${att.name}"`, `"${att.company}"`, `"${att.jobTitle}"`, att.signature ? 'Yes (Digital)' : 'No', att.signTime || '', isLate ? 'LATE' : 'On Time'
                ];
            });
            return [metaHeaders.join(','), metaRow.join(','), '', attendeeHeaders.join(','), ...attendeeRows.map(r => r.join(','))].join('\n');
        };

        const generateMasterCSV = (sheets) => {
            const headers = ['Date', 'Timeline', 'Meeting Name', 'Meeting Start', 'Meeting End', 'Duration', 'Meeting Type', 'Topic', 'Site', 'Conducted By', 'Conductor Signed', 'Attendee Name', 'Company', 'Job Title', 'Attendee Signed', 'Sign Time', 'Status'];
            let allRows = [];
            sheets.forEach(sheet => {
                sheet.attendees.filter(att => att.name && att.name.trim() !== '').forEach(att => {
                    const isLate = checkIsLate(att.signTime, sheet.startTime);
                    allRows.push({
                        date: sheet.date, session: sheet.session || 'Morning', meetingName: sheet.meetingName || '', startTime: sheet.startTime, endTime: sheet.endTime, duration: sheet.duration || '', type: sheet.type, topic: sheet.topic, site: sheet.site, conductedBy: sheet.conductedBy, conductorSigned: sheet.conductorSignature ? 'Yes' : 'No',
                        name: att.name, company: att.company, jobTitle: att.jobTitle, signed: att.signature ? 'Yes' : 'No', signTime: att.signTime || '', status: isLate ? 'LATE' : 'On Time', sortKey: new Date(`${sheet.date}T${att.signTime || '23:59'}`).getTime()
                    });
                });
            });
            allRows.sort((a, b) => a.sortKey - b.sortKey);
            const csvRows = allRows.map(r => [r.date, r.session, `"${r.meetingName}"`, r.startTime, r.endTime, `"${r.duration}"`, r.type, `"${r.topic}"`, `"${r.site}"`, `"${r.conductedBy}"`, r.conductorSigned, `"${r.name}"`, `"${r.company}"`, `"${r.jobTitle}"`, r.signed, r.signTime, r.status]);
            return [headers.join(','), ...csvRows.map(r => r.join(','))].join('\n');
        };

        // --- Components ---

        // Connection Status Component
        const ConnectionStatus = ({ status, onRetry }) => {
            const statusConfig = {
                online: { color: 'connection-online', text: 'Online', icon: <Wifi size={12} /> },
                offline: { color: 'connection-offline', text: 'Offline', icon: <WifiOff size={12} /> },
                syncing: { color: 'connection-syncing', text: 'Syncing', icon: <RefreshCw size={12} className="animate-spin" /> }
            };

            const config = statusConfig[status] || statusConfig.offline;

            return (
                <div className="flex items-center space-x-2 text-xs">
                    <div className={`connection-dot ${config.color}`}></div>
                    <span className="text-gray-600">{config.text}</span>
                    {config.icon}
                    {status === 'offline' && (
                        <button onClick={onRetry} className="text-blue-600 hover:text-blue-800 ml-2">
                            <RefreshCw size={12} />
                        </button>
                    )}
                </div>
            );
        };

        // Interactive Video Tutorial Component
        const HelpModal = ({ onClose }) => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [hasStarted, setHasStarted] = useState(false);

            const slides = [
                {
                    title: "Welcome to PAMICOR Attendance",
                    content: "This tutorial will show you how to mark your attendance step by step.",
                    visual: "ðŸ¢",
                    bgColor: "bg-blue-50",
                    textColor: "text-blue-800"
                },
                {
                    title: "Step 1: Click 'Add My Attendance'",
                    content: "On the login screen, look for the blue button that says 'Add My Attendance' and click it.",
                    visual: "ðŸ‘†",
                    bgColor: "bg-green-50",
                    textColor: "text-green-800"
                },
                {
                    title: "Step 2: Enter Your Full Name",
                    content: "Type your complete name in the first box. Make sure to spell it correctly.",
                    visual: "âœï¸",
                    bgColor: "bg-purple-50",
                    textColor: "text-purple-800"
                },
                {
                    title: "Step 3: Select Your Company",
                    content: "Click the dropdown and choose your company: Pamicor, Visitor, Contractor, or WTP.",
                    visual: "ðŸ­",
                    bgColor: "bg-orange-50",
                    textColor: "text-orange-800"
                },
                {
                    title: "Step 4: Choose Your Job Title",
                    content: "Select your job title from the list. Pick the one that matches your role.",
                    visual: "ðŸ‘·",
                    bgColor: "bg-indigo-50",
                    textColor: "text-indigo-800"
                },
                {
                    title: "Step 5: Sign Your Name",
                    content: "Tap the signature box and use your finger to write your signature on the screen.",
                    visual: "âœï¸",
                    bgColor: "bg-pink-50",
                    textColor: "text-pink-800"
                },
                {
                    title: "Step 6: Submit Your Attendance",
                    content: "Click the blue 'Submit Attendance' button to save your information.",
                    visual: "âœ…",
                    bgColor: "bg-green-50",
                    textColor: "text-green-800"
                },
                {
                    title: "All Done!",
                    content: "Your attendance has been recorded. You will see a success message. Thank you!",
                    visual: "ðŸŽ‰",
                    bgColor: "bg-yellow-50",
                    textColor: "text-yellow-800"
                }
            ];

            const nextSlide = () => {
                if (currentSlide < slides.length - 1) {
                    setCurrentSlide(currentSlide + 1);
                }
            };

            const prevSlide = () => {
                if (currentSlide > 0) {
                    setCurrentSlide(currentSlide - 1);
                }
            };

            const intervalRef = useRef(null);

            useEffect(() => {
                if (isPlaying) {
                    intervalRef.current = setInterval(() => {
                        setCurrentSlide(prev => {
                            if (prev >= slides.length - 1) {
                                setIsPlaying(false);
                                return prev;
                            }
                            return prev + 1;
                        });
                    }, 3000);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                }
                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isPlaying]);

            const startTutorial = () => {
                setHasStarted(true);
                setIsPlaying(true);
            };

            const startAutoPlay = () => {
                setIsPlaying(true);
            };

            const stopAutoPlay = () => {
                setIsPlaying(false);
            };

            const slide = slides[currentSlide];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-900 text-white">
                            <h3 className="font-bold flex items-center text-lg">
                                <Play className="mr-2" size={24}/> Video Tutorial
                            </h3>
                            <button onClick={onClose} className="text-blue-200 hover:text-white">
                                <X size={24}/>
                            </button>
                        </div>
                        
                        {/* Video-like Content Area */}
                        <div className="relative">
                            {!hasStarted ? (
                                <div className="bg-gradient-to-br from-blue-900 to-purple-900 p-12 text-center min-h-[400px] flex flex-col justify-center relative">
                                    <div className="text-white text-6xl mb-6">ðŸŽ¬</div>
                                    <h2 className="text-4xl font-bold text-white mb-4">Video Tutorial</h2>
                                    <p className="text-xl text-blue-200 mb-8">Learn how to mark your attendance step by step</p>
                                    <button 
                                        onClick={startTutorial}
                                        className="mx-auto w-24 h-24 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center shadow-2xl transform hover:scale-110 transition-all duration-300 group"
                                    >
                                        <Play size={32} className="text-white ml-1 group-hover:scale-110 transition-transform" />
                                    </button>
                                    <p className="text-sm text-blue-300 mt-4">Click the play button to start</p>
                                </div>
                            ) : (
                                <div className={`${slide.bgColor} p-12 text-center min-h-[400px] flex flex-col justify-center`}>
                                    <div className="text-8xl mb-6">{slide.visual}</div>
                                    <h2 className={`text-3xl font-bold ${slide.textColor} mb-6`}>{slide.title}</h2>
                                    <p className={`text-xl ${slide.textColor} leading-relaxed max-w-2xl mx-auto`}>{slide.content}</p>
                                </div>
                            )}
                        </div>

                        {/* Video Controls */}
                        {hasStarted && (
                        <div className="p-6 bg-gray-50 border-t">
                            {/* Progress Bar */}
                            <div className="mb-4">
                                <div className="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>Step {currentSlide + 1} of {slides.length}</span>
                                    <span>{Math.round(((currentSlide + 1) / slides.length) * 100)}% Complete</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-3">
                                    <div 
                                        className="bg-blue-600 h-3 rounded-full transition-all duration-300" 
                                        style={{ width: `${((currentSlide + 1) / slides.length) * 100}%` }}
                                    ></div>
                                </div>
                            </div>

                            {/* Control Buttons */}
                            <div className="flex justify-between items-center">
                                <button 
                                    onClick={prevSlide} 
                                    disabled={currentSlide === 0}
                                    className="flex items-center px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 transition-colors"
                                >
                                    <ChevronLeft size={20} className="mr-2"/> Previous
                                </button>

                                <div className="flex space-x-3">
                                    {!isPlaying ? (
                                        <button 
                                            onClick={startAutoPlay}
                                            className="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
                                        >
                                            <Play size={20} className="mr-2"/> Auto Play
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={stopAutoPlay}
                                            className="flex items-center px-6 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors"
                                        >
                                            <X size={20} className="mr-2"/> Stop
                                        </button>
                                    )}
                                    
                                    <button 
                                        onClick={() => setCurrentSlide(0)}
                                        className="flex items-center px-6 py-3 bg-yellow-600 text-white rounded-lg font-medium hover:bg-yellow-700 transition-colors"
                                    >
                                        <RotateCcw size={20} className="mr-2"/> Restart
                                    </button>
                                </div>

                                <button 
                                    onClick={nextSlide} 
                                    disabled={currentSlide === slides.length - 1}
                                    className="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
                                >
                                    Next <ChevronDown size={20} className="ml-2 rotate-[-90deg]"/>
                                </button>
                            </div>
                        </div>
                        )}
                    </div>
                </div>
            );
        };

        // QR Code Modal Component
        const QRCodeModal = ({ meetingId, meetingName, onClose }) => {
            const qrCodeUrl = generateQRCode(meetingId);
            const attendUrl = `${window.location.origin}/attend/${meetingId}`;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-900 text-white rounded-t-lg">
                            <h3 className="font-bold flex items-center">
                                <QrCode className="mr-2" size={20}/> QR Code for Attendance
                            </h3>
                            <button onClick={onClose} className="text-blue-200 hover:text-white">
                                <X size={20}/>
                            </button>
                        </div>
                        <div className="p-6 text-center">
                            <h4 className="font-bold text-gray-800 mb-2">{meetingName || 'Meeting Attendance'}</h4>
                            <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                <img src={qrCodeUrl} alt="QR Code" className="mx-auto mb-2" />
                                <p className="text-xs text-gray-600">Scan to join attendance</p>
                            </div>
                            <div className="text-left bg-gray-100 p-3 rounded text-xs">
                                <p className="font-bold mb-1">Direct Link:</p>
                                <p className="break-all text-blue-600">{attendUrl}</p>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg">
                            <button onClick={onClose} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SignaturePad = ({ onSave, onCancel, signerName }) => {
            const canvasRef = useRef(null);
            const isDrawing = useRef(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                setTimeout(() => {
                    if (canvas) {
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = 200;
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                    }
                }, 10);
            }, []);

            const getCoordinates = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDrawing = (e) => {
                const { x, y } = getCoordinates(e);
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                isDrawing.current = true;
            };

            const draw = (e) => {
                if (!isDrawing.current) return;
                const { x, y } = getCoordinates(e);
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const endDrawing = () => {
                isDrawing.current = false;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
            };

            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            const handleSave = () => {
                const canvas = canvasRef.current;
                onSave(canvas.toDataURL());
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                            <h3 className="font-bold text-gray-800">Sign for {signerName || 'Attendee'}</h3>
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-700"><X size={20} /></button>
                        </div>
                        <div className="p-4 bg-white flex-grow">
                            <div className="border-2 border-dashed border-gray-300 rounded bg-gray-50 touch-none h-52">
                                <canvas ref={canvasRef} className="w-full h-full cursor-crosshair touch-none"
                                    onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={endDrawing} onMouseLeave={endDrawing}
                                    onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={endDrawing}
                                />
                            </div>
                            <p className="text-center text-xs text-gray-400 mt-2">Draw your signature above</p>
                        </div>
                        <div className="p-4 border-t flex justify-between items-center bg-gray-50 rounded-b-lg">
                            <button onClick={clearCanvas} className="text-red-500 text-sm hover:underline">Clear</button>
                            <div className="space-x-2">
                                <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm">Cancel</button>
                                <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold shadow-sm">Save Signature</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickAddModal = ({ history, onAdd, onClose }) => {
            const [search, setSearch] = useState('');
            const [selected, setSelected] = useState([]);
            const [manualText, setManualText] = useState('');
            const fileInputRef = useRef(null);

            const uniqueEmployees = useMemo(() => {
                const map = new Map();
                history.forEach(sheet => {
                    sheet.attendees.forEach(att => {
                        if (att.name && !map.has(att.name)) {
                            map.set(att.name, { name: att.name, company: att.company, jobTitle: att.jobTitle });
                        }
                    });
                });
                const list = Array.from(map.values());
                // Sort A-Z
                return list.sort((a, b) => a.name.localeCompare(b.name));
            }, [history]);

            const filteredEmployees = uniqueEmployees.filter(e => e.name.toLowerCase().includes(search.toLowerCase()));

            const handleAdd = () => {
                const fromHistory = selected.map(name => uniqueEmployees.find(e => e.name === name));
                // Change default company to empty string as requested
                const fromManual = manualText.split('\n').filter(n => n.trim()).map(n => ({ name: n.trim(), company: '', jobTitle: '' }));
                onAdd([...fromHistory, ...fromManual]);
                onClose();
            };
            
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    // Simple CSV parsing logic
                    const lines = text.split(/\r?\n/).map(line => {
                         const parts = line.split(',');
                         let name = parts[0].trim();
                         name = name.replace(/^"|"$/g, '');
                         return name;
                    }).filter(name => name && name.toLowerCase() !== 'name' && name.toLowerCase() !== 'attendee name'); 
                    
                    const existing = manualText ? manualText + '\n' : '';
                    setManualText(existing + lines.join('\n'));
                    e.target.value = null; 
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-900 text-white rounded-t-lg">
                            <h3 className="font-bold flex items-center"><Users className="mr-2" size={20}/> Quick Add Attendees</h3>
                            <button onClick={onClose} className="text-blue-200 hover:text-white"><X size={20}/></button>
                        </div>
                        <div className="flex-grow overflow-hidden flex flex-col md:flex-row">
                            <div className="w-full md:w-1/2 p-4 border-r border-gray-200 flex flex-col h-full">
                                <h4 className="font-bold text-gray-700 mb-2 text-sm">Select Previous Staff</h4>
                                <div className="relative mb-2">
                                    <Search size={14} className="absolute left-2 top-2.5 text-gray-400"/>
                                    <input type="text" placeholder="Search names..." className="w-full pl-8 pr-2 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        value={search} onChange={e => setSearch(e.target.value)} />
                                </div>
                                <div className="flex-grow overflow-y-auto border rounded bg-gray-50 p-2 space-y-1 h-full">
                                    {filteredEmployees.map(emp => (
                                        <div key={emp.name} onClick={() => setSelected(prev => prev.includes(emp.name) ? prev.filter(n => n !== emp.name) : [...prev, emp.name])}
                                            className={`p-2 rounded cursor-pointer text-sm flex items-center justify-between ${selected.includes(emp.name) ? 'bg-blue-100 text-blue-800 border-blue-300 border' : 'bg-white hover:bg-gray-100 border border-transparent'}`}>
                                            <div><div className="font-medium">{emp.name}</div><div className="text-[10px] text-gray-500">{emp.jobTitle}</div></div>
                                            {selected.includes(emp.name) && <Check size={14} className="text-blue-600"/>}
                                        </div>
                                    ))}
                                    {filteredEmployees.length === 0 && <div className="text-center text-gray-400 text-xs mt-4">No records found.</div>}
                                </div>
                            </div>
                            <div className="w-full md:w-1/2 p-4 flex flex-col">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-bold text-gray-700 text-sm">Paste / Import List</h4>
                                    <div className="relative">
                                        <input 
                                            type="file" 
                                            accept=".csv,.txt" 
                                            className="hidden" 
                                            ref={fileInputRef} 
                                            onChange={handleFileUpload} 
                                        />
                                        <button 
                                            onClick={() => fileInputRef.current.click()} 
                                            className="flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded border border-gray-300"
                                            title="Import Names from CSV"
                                        >
                                            <Upload size={12} className="mr-1"/> Import CSV
                                        </button>
                                    </div>
                                </div>
                                <textarea className="flex-grow w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono"
                                    placeholder={"John Doe\nJane Smith..."} value={manualText} onChange={e => setManualText(e.target.value)} />
                                <p className="text-xs text-gray-400 mt-1">Paste names separated by new lines. Fields will be blank.</p>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center space-x-3 rounded-b-lg">
                            <span className="text-sm text-gray-500">Adding {selected.length + manualText.split('\n').filter(n=>n.trim()).length} people</span>
                            <button onClick={handleAdd} className="px-6 py-2 bg-blue-600 text-white rounded font-bold shadow-sm hover:bg-blue-700">Add All</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onAttendeeMode }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [helpOpen, setHelpOpen] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username.toLowerCase() === 'admin' && password === 'Rich@0322') {
                    onLogin(username);
                } else {
                    setError('Invalid credentials. Please try again.');
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    {helpOpen && <HelpModal onClose={() => setHelpOpen(false)} />}
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
                        <div className="bg-blue-900 p-8 text-center">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white mb-4 shadow-lg"><ShieldCheck size={32} className="text-blue-900" /></div>
                            <h1 className="text-2xl font-bold text-white">PAMICOR</h1>
                            <p className="text-blue-200 text-sm">Attendance Management System</p>
                        </div>
                        <div className="p-8">
                            <form onSubmit={handleSubmit} className="mb-6 pb-6 border-b border-gray-100">
                                <div className="mb-4">
                                    <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center"><User size={16} className="mr-2 text-gray-400" /> Username</label>
                                    <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter username" />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-gray-700 text-sm font-bold mb-2 flex items-center"><KeyRound size={16} className="mr-2 text-gray-400" /> Password</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter password" />
                                </div>
                                {error && <div className="mb-4 p-3 bg-red-50 text-red-600 text-xs rounded border border-red-200 flex items-center"><X size={14} className="mr-2" /> {error}</div>}
                                <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded hover:bg-blue-700 flex justify-center items-center transition-colors"><Lock size={18} className="mr-2" /> Login as Admin</button>
                            </form>
                            
                            <div className="text-center">
                                <p className="text-sm text-gray-500 mb-3">Just marking attendance?</p>
                                <button onClick={onAttendeeMode} className="w-full bg-white border-2 border-blue-600 text-blue-600 font-bold py-3 px-4 rounded hover:bg-blue-50 flex justify-center items-center transition-colors">
                                    <UserPlus size={18} className="mr-2" /> Add My Attendance
                                </button>
                                <button onClick={() => setHelpOpen(true)} className="w-full bg-green-50 border-2 border-green-600 text-green-600 font-bold py-3 px-4 rounded hover:bg-green-100 flex justify-center items-center transition-colors mt-3">
                                    <BookOpen size={18} className="mr-2" /> Help & Training
                                </button>
                            </div>
                        </div>
                        <div className="bg-gray-50 p-3 text-center border-t border-gray-100"><p className="text-[10px] text-gray-400">Restricted Access â€¢ AngloGold Ashanti Sites</p></div>
                    </div>
                </div>
            );
        };

        const AttendeeForm = ({ onBack, onSubmit }) => {
            const [name, setName] = useState('');
            const [company, setCompany] = useState('');
            const [jobTitle, setJobTitle] = useState('');
            const [signature, setSignature] = useState(null);
            const [signingOpen, setSigningOpen] = useState(false);
            const [successMsg, setSuccessMsg] = useState('');
            
            // Live Clock for Kiosk
            const [currentTime, setCurrentTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const handleSubmit = () => {
                if (!name || !company || !jobTitle || !signature) {
                    alert("Please fill all fields and sign.");
                    return;
                }
                onSubmit({ name, company, jobTitle, signature });
                setSuccessMsg(`Attendance recorded for ${name}. Please hand over to next person.`);
                setTimeout(() => {
                    setSuccessMsg('');
                    setName('');
                    setCompany('');
                    setJobTitle('');
                    setSignature(null);
                }, 3000);
            };

            if (successMsg) {
                return (
                    <div className="min-h-screen bg-green-50 flex items-center justify-center p-4">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><Check size={40} className="text-green-600"/></div>
                            <h2 className="text-2xl font-bold text-green-800 mb-2">Success!</h2>
                            <p className="text-green-600">{successMsg}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    {signingOpen && <SignaturePad signerName={name || 'Myself'} onSave={(data) => { setSignature(data); setSigningOpen(false); }} onCancel={() => setSigningOpen(false)} />}
                    <div className="bg-blue-900 text-white p-4 shadow-md flex items-center justify-between">
                        <div className="flex items-center">
                            <button onClick={onBack} className="mr-4 p-2 hover:bg-blue-800 rounded-full"><ArrowLeft size={20} /></button>
                            <h1 className="font-bold text-lg">Add Your Attendance</h1>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-blue-200 uppercase font-bold">Current Time</div>
                            <div className="text-xl font-mono font-bold">{currentTime.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                    <div className="flex-grow p-6 max-w-lg mx-auto w-full">
                        <div className="bg-white rounded-lg shadow-md p-6 space-y-6">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Full Name</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. John Doe" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Company</label>
                                <div className="relative">
                                    <select value={company} onChange={e => setCompany(e.target.value)} className="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white">
                                        <option value="">Select Company...</option>
                                        {COMPANY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                    <ChevronDown size={16} className="absolute right-3 top-4 text-gray-400 pointer-events-none" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Job Title</label>
                                <div className="relative">
                                    <select value={jobTitle} onChange={e => setJobTitle(e.target.value)} className="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white">
                                        <option value="">Select Job Title...</option>
                                        {JOB_TITLE_OPTIONS.map(j => <option key={j} value={j}>{j}</option>)}
                                    </select>
                                    <ChevronDown size={16} className="absolute right-3 top-4 text-gray-400 pointer-events-none" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Signature</label>
                                <div onClick={() => setSigningOpen(true)} className={`w-full h-24 border-2 border-dashed rounded-md flex items-center justify-center cursor-pointer ${signature ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'}`}>
                                    {signature ? <img src={signature} className="h-full object-contain" /> : <div className="text-gray-400 flex items-center"><PenTool size={16} className="mr-2"/> Tap to Sign</div>}
                                </div>
                            </div>
                            <button onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg shadow-md hover:bg-blue-700 transition-all">Submit Attendance</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center toast-enter z-50">
                    <Check size={20} className="mr-2" />
                    <span className="font-medium">{message}</span>
                </div>
            );
        };

        // --- Main App ---
        const PamicorAttendanceSystem = () => {
            const [view, setView] = useState('login'); // login, admin, attendee
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [activeSheetId, setActiveSheetId] = useState(null);
            const [signingState, setSigningState] = useState({ isOpen: false, type: null, attendeeId: null });
            const [quickAddOpen, setQuickAddOpen] = useState(false);
            const [qrCodeOpen, setQrCodeOpen] = useState(false);
            const [helpOpen, setHelpOpen] = useState(false);
            const [showToast, setShowToast] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('offline');
            const [sheets, setSheets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            // ADMIN LIVE CLOCK
            const [adminTime, setAdminTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setAdminTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Enhanced data loading with multiple fallback layers
            useEffect(() => {
                const initializeApp = async () => {
                    setIsLoading(true);
                    let loadedData = [];
                    
                    // Layer 1: Try Supabase first
                    const connectionTest = await SupabaseService.testConnection();
                    if (connectionTest.success) {
                        setConnectionStatus('online');
                        const result = await SupabaseService.loadAllMeetings();
                        if (result.success && result.data.length > 0) {
                            loadedData = result.data;
                            // Save to localStorage as backup
                            localStorage.setItem('pamicor_sheets_v2', JSON.stringify(loadedData));
                            localStorage.setItem('pamicor_backup_' + new Date().toISOString().split('T')[0], JSON.stringify(loadedData));
                        }
                    } else {
                        setConnectionStatus('offline');
                    }
                    
                    // Layer 2: Fallback to localStorage if Supabase failed or empty
                    if (loadedData.length === 0) {
                        const saved = localStorage.getItem('pamicor_sheets_v2');
                        if (saved) {
                            try {
                                const parsedData = JSON.parse(saved);
                                if (parsedData.length > 0) {
                                    loadedData = parsedData;
                                }
                            } catch (e) {
                                console.error('Error parsing localStorage data:', e);
                            }
                        }
                    }
                    
                    // Layer 3: Try daily backups if main localStorage failed
                    if (loadedData.length === 0) {
                        const today = new Date();
                        for (let i = 0; i < 30; i++) { // Check last 30 days
                            const checkDate = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                            const dateKey = 'pamicor_backup_' + checkDate.toISOString().split('T')[0];
                            const backup = localStorage.getItem(dateKey);
                            if (backup) {
                                try {
                                    const backupData = JSON.parse(backup);
                                    if (backupData.length > 0) {
                                        loadedData = backupData;
                                        // Restore to main storage
                                        localStorage.setItem('pamicor_sheets_v2', JSON.stringify(loadedData));
                                        break;
                                    }
                                } catch (e) {
                                    console.error('Error parsing backup data:', e);
                                }
                            }
                        }
                    }
                    
                    setSheets(loadedData);
                    setIsLoading(false);
                };

                initializeApp();
            }, []);

            // Enhanced auto-save with multiple backup layers
            useEffect(() => {
                if (sheets.length > 0) {
                    // Layer 1: Immediate localStorage save
                    localStorage.setItem('pamicor_sheets_v2', JSON.stringify(sheets));
                    
                    // Layer 2: Daily backup
                    const today = new Date().toISOString().split('T')[0];
                    localStorage.setItem('pamicor_backup_' + today, JSON.stringify(sheets));
                    
                    // Layer 3: Session backup (in case of browser crash)
                    sessionStorage.setItem('pamicor_session_backup', JSON.stringify(sheets));
                    
                    if (connectionStatus === 'online') {
                        // Layer 4: Supabase cloud backup
                        const saveTimer = setTimeout(async () => {
                            setConnectionStatus('syncing');
                            
                            // Save ALL modified sheets, not just the most recent
                            const savePromises = sheets.map(async (sheet) => {
                                const result = await SupabaseService.saveMeeting(sheet);
                                return result;
                            });
                            
                            try {
                                await Promise.all(savePromises);
                                setConnectionStatus('online');
                            } catch (error) {
                                console.error('Error saving to Supabase:', error);
                                setConnectionStatus('offline');
                            }
                        }, 2000);

                        return () => clearTimeout(saveTimer);
                    }
                }
            }, [sheets, connectionStatus]);

            // Listener for cross-tab updates (Real-time sync)
            useEffect(() => {
                const handleStorageChange = (e) => {
                    if (e.key === 'pamicor_sheets_v2') {
                        setSheets(JSON.parse(e.newValue));
                    }
                };
                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, []);

            const retryConnection = async () => {
                setConnectionStatus('syncing');
                const connectionTest = await SupabaseService.testConnection();
                
                if (connectionTest.success) {
                    setConnectionStatus('online');
                    const result = await SupabaseService.loadAllMeetings();
                    if (result.success && result.data.length > 0) {
                        // Merge cloud data with local data to ensure nothing is lost
                        const localData = sheets;
                        const cloudData = result.data;
                        
                        // Create a map of existing IDs
                        const mergedData = [...cloudData];
                        const cloudIds = new Set(cloudData.map(s => s.id));
                        
                        // Add any local sheets that aren't in cloud
                        localData.forEach(localSheet => {
                            if (!cloudIds.has(localSheet.id)) {
                                mergedData.push(localSheet);
                            }
                        });
                        
                        // Sort by date (newest first)
                        mergedData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        
                        setSheets(mergedData);
                        
                        // Save merged data back to localStorage
                        localStorage.setItem('pamicor_sheets_v2', JSON.stringify(mergedData));
                    }
                } else {
                    setConnectionStatus('offline');
                }
            };

            const createNewSheet = () => {
                const autoSession = getAutoSession();
                const defaultTimes = TIMELINES[autoSession];

                const newSheet = {
                    id: generateId(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    type: 'Meeting',
                    topic: '',
                    meetingName: '',
                    date: new Date().toISOString().split('T')[0],
                    session: autoSession,
                    startTime: defaultTimes.start,
                    endTime: defaultTimes.end,
                    duration: calculateDuration(defaultTimes.start, defaultTimes.end),
                    site: '',
                    conductedBy: '',
                    conductorSignature: null,
                    conductorSignTime: null,
                    attendees: Array(5).fill(null).map(() => ({
                        id: generateId(),
                        name: '',
                        company: 'Pamicor',
                        jobTitle: '',
                        signature: null,
                        signTime: null
                    })),
                    minutes: ''
                };
                setSheets([newSheet, ...sheets]);
                setActiveSheetId(newSheet.id);
            };

            const updateSheet = (id, field, value) => {
                setSheets(sheets.map(sheet => {
                    if (sheet.id !== id) return sheet;
                    const updated = { ...sheet, [field]: value };
                    
                    // Handle Session Change Logic
                    if (field === 'session') {
                        const newTimes = TIMELINES[value];
                        if (newTimes) {
                            updated.startTime = newTimes.start;
                            updated.endTime = newTimes.end;
                            updated.duration = calculateDuration(newTimes.start, newTimes.end);
                        }
                    }
                    
                    if (field === 'startTime' || field === 'endTime') {
                        updated.duration = calculateDuration(updated.startTime, updated.endTime);
                    }
                    // Update updatedAt timestamp whenever sheet is modified
                    updated.updatedAt = new Date().toISOString();
                    return updated;
                }));
            };

            const deleteSheet = async (id, e) => {
                e.stopPropagation();
                if (confirm('Delete this record? This will move it to archive instead of permanent deletion.')) {
                    // Instead of deleting, mark as archived for data safety
                    const updatedSheets = sheets.map(s => {
                        if (s.id === id) {
                            return { ...s, archived: true, archivedAt: new Date().toISOString() };
                        }
                        return s;
                    });
                    
                    setSheets(updatedSheets);
                    
                    // Save archived record to special backup
                    const archivedSheet = sheets.find(s => s.id === id);
                    if (archivedSheet) {
                        const archiveKey = 'pamicor_archive_' + new Date().toISOString().split('T')[0];
                        const existingArchive = localStorage.getItem(archiveKey);
                        const archiveData = existingArchive ? JSON.parse(existingArchive) : [];
                        archiveData.push(archivedSheet);
                        localStorage.setItem(archiveKey, JSON.stringify(archiveData));
                    }
                    
                    if (activeSheetId === id) setActiveSheetId(null);
                }
            };

            const updateAttendee = (sheetId, attendeeId, field, value) => {
                setSheets(sheets.map(s => {
                    if (s.id !== sheetId) return s;
                    return { 
                        ...s, 
                        updatedAt: new Date().toISOString(), // Update sheet timestamp on attendee change
                        attendees: s.attendees.map(a => a.id === attendeeId ? { ...a, [field]: value } : a) 
                    };
                }));
            };

            const clearSignature = (sheetId, attendeeId) => {
                if(!confirm("Are you sure you want to clear this signature?")) return;
                setSheets(sheets.map(s => {
                    if (s.id !== sheetId) return s;
                    return { ...s, attendees: s.attendees.map(a => a.id === attendeeId ? { ...a, signature: null, signTime: null } : a) };
                }));
            };

            const saveSignature = (data) => {
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                setSheets(sheets.map(s => {
                    if (s.id !== activeSheetId) return s;
                    if (signingState.type === 'conductor') return { ...s, conductorSignature: data, conductorSignTime: time, updatedAt: new Date().toISOString() };
                    return { ...s, updatedAt: new Date().toISOString(), attendees: s.attendees.map(a => a.id === signingState.attendeeId ? { ...a, signature: data, signTime: time } : a) };
                }));
                setSigningState({ isOpen: false, type: null, attendeeId: null });
            };

            const handleManualSave = async () => {
                if (activeSheetId && connectionStatus === 'online') {
                    setConnectionStatus('syncing');
                    const activeSheet = sheets.find(s => s.id === activeSheetId);
                    if (activeSheet) {
                        const result = await SupabaseService.saveMeeting(activeSheet);
                        setConnectionStatus(result.success ? 'online' : 'offline');
                        setShowToast(true);
                    }
                } else {
                    setShowToast(true);
                }
                
                if (activeSheetId) {
                    updateSheet(activeSheetId, 'updatedAt', new Date().toISOString());
                }
            };

            const addBulkAttendees = (newAttendees) => {
                if (!activeSheetId) return;
                const formatted = newAttendees.map(p => ({ id: generateId(), name: p.name, company: p.company || 'Pamicor', jobTitle: p.jobTitle || '', signature: null, signTime: null }));
                
                setSheets(sheets.map(s => {
                    if (s.id !== activeSheetId) return s;
                    // Filter out empty placeholders ONLY if we are adding bulk names to avoid confusion,
                    // but if the user wants to keep them, we can just append.
                    // Let's append to existing real ones and remove blank ones to keep list clean.
                    const existingReal = s.attendees.filter(a => a.name.trim() !== '');
                    return { ...s, attendees: [...existingReal, ...formatted] };
                }));
            };

            const handleAttendeeSubmit = (data) => {
                const currentDetails = new Date();
                const timeStr = currentDetails.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', hour12: false});

                const newAttendee = {
                    id: generateId(),
                    name: data.name,
                    company: data.company,
                    jobTitle: data.jobTitle,
                    signature: data.signature,
                    signTime: timeStr,
                    isLate: false
                };

                setSheets(prevSheets => {
                    let targetSheetId = activeSheetId; // Use active ID if Kiosk was navigated from Admin within same session

                    if (!targetSheetId) {
                        const today = new Date().toISOString().split('T')[0];
                        // SMART LINKING: Find ALL sheets for today
                        const todaySheets = prevSheets.filter(s => s.date === today);
                        
                        if (todaySheets.length > 0) {
                            // Sort by 'updatedAt' if available (newest first), otherwise fallback to created order
                            // Ideally picking the one most recently modified by Admin
                            todaySheets.sort((a, b) => {
                                const timeA = a.updatedAt ? new Date(a.updatedAt).getTime() : new Date(a.createdAt).getTime();
                                const timeB = b.updatedAt ? new Date(b.updatedAt).getTime() : new Date(b.createdAt).getTime();
                                return timeB - timeA;
                            });
                            targetSheetId = todaySheets[0].id;
                        }
                    }

                    if (targetSheetId) {
                        return prevSheets.map(s => {
                            if (s.id !== targetSheetId) return s;
                            if (s.startTime) {
                                newAttendee.isLate = checkIsLate(timeStr, s.startTime);
                            }
                            const realAttendees = s.attendees.filter(a => a.name && a.name.trim() !== '');
                            return { ...s, updatedAt: new Date().toISOString(), attendees: [...realAttendees, newAttendee] };
                        });
                    }

                    // Case B: Auto-create new sheet
                    const newSheetId = generateId();
                    const today = new Date().toISOString().split('T')[0];
                    const autoSession = getAutoSession();
                    const defaultTimes = TIMELINES[autoSession];
                    
                    const isLateAuto = checkIsLate(timeStr, defaultTimes.start);
                    newAttendee.isLate = isLateAuto;

                    const newSheet = {
                        id: newSheetId, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), 
                        type: 'Meeting', topic: '', 
                        meetingName: 'New Attendance Sheet', date: today, 
                        session: autoSession, startTime: defaultTimes.start,
                        endTime: defaultTimes.end, duration: calculateDuration(defaultTimes.start, defaultTimes.end), 
                        site: '', conductedBy: '', conductorSignature: null, conductorSignTime: null,
                        attendees: [newAttendee], minutes: ''
                    };
                    
                    return [newSheet, ...prevSheets];
                });
            };

            const activeSheet = sheets.find(s => s.id === activeSheetId);
            let currentSignerName = 'Attendee';
            if (signingState.isOpen) {
                currentSignerName = signingState.type === 'conductor' ? (activeSheet?.conductedBy || 'Conductor') : (activeSheet?.attendees.find(a => a.id === signingState.attendeeId)?.name || 'Attendee');
            }

            // Stats Calculation
            const stats = useMemo(() => {
                if (!activeSheet) return { total: 0, signed: 0, late: 0 };
                const valid = activeSheet.attendees.filter(a => a.name && a.name.trim() !== '');
                const signed = valid.filter(a => a.signature).length;
                const late = valid.filter(a => checkIsLate(a.signTime, activeSheet.startTime)).length;
                return { total: valid.length, signed, late };
            }, [activeSheet]);

            if (view === 'login') return <LoginScreen onLogin={(u) => { setCurrentUser(u); setView('admin'); }} onAttendeeMode={() => setView('attendee')} />;
            
            if (view === 'attendee') return <AttendeeForm onBack={() => setView('login')} onSubmit={handleAttendeeSubmit} />;

            return (
                <div className="min-h-screen bg-gray-100 flex overflow-hidden font-sans">
                    {showToast && <Toast message="Progress Saved Successfully" onClose={() => setShowToast(false)} />}
                    {signingState.isOpen && <SignaturePad signerName={currentSignerName} onSave={saveSignature} onCancel={() => setSigningState({ isOpen: false, type: null, attendeeId: null })} />}
                    {quickAddOpen && <QuickAddModal history={sheets} onAdd={addBulkAttendees} onClose={() => setQuickAddOpen(false)} />}
                    {qrCodeOpen && (
                        activeSheetId ? 
                            <QRCodeModal meetingId={activeSheetId} meetingName={activeSheet?.meetingName} onClose={() => setQrCodeOpen(false)} /> :
                            <QRCodeModal isSystemQR={true} onClose={() => setQrCodeOpen(false)} />
                    )}
                    {helpOpen && <HelpModal onClose={() => setHelpOpen(false)} />}
                    
                    <aside className={`${sidebarOpen ? 'w-80' : 'w-0'} bg-white border-r border-gray-200 flex flex-col fixed md:relative h-full z-20 transition-all print:hidden`}>
                        <div className="p-4 border-b flex justify-between bg-gray-50"><h2 className="font-bold text-gray-700 flex items-center"><History size={18} className="mr-2"/> Records</h2><button onClick={() => setSidebarOpen(false)} className="md:hidden text-gray-500"><ChevronLeft/></button></div>
                        <div className="p-3">
                            <button onClick={createNewSheet} className="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md flex items-center justify-center text-sm font-medium mb-4"><Plus size={16} className="mr-1" /> New Sheet</button>
                            <div className="space-y-2 overflow-y-auto h-[calc(100vh-180px)]">
                                {sheets.filter(sheet => !sheet.archived).map(sheet => (
                                    <div key={sheet.id} onClick={() => setActiveSheetId(sheet.id)} className={`p-3 rounded-lg border cursor-pointer transition-all relative group ${activeSheetId === sheet.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-100'}`}>
                                        <div className="flex justify-between mb-1"><span className="text-xs font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded">{sheet.type}</span><span className="text-xs text-gray-400">{formatDate(sheet.date)}</span></div>
                                        <h3 className="text-sm font-medium text-gray-800 truncate mb-1">{sheet.meetingName || sheet.topic || 'Untitled'}</h3>
                                        <div className="text-xs text-gray-500 flex items-center"><MapPin size={10} className="mr-1"/> {sheet.site}</div>
                                        <button onClick={(e) => deleteSheet(sheet.id, e)} className="absolute right-2 bottom-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={14} /></button>
                                    </div>
                                ))}
                            </div>
                            <div className="absolute bottom-0 left-0 w-full p-3 bg-gray-50 border-t space-y-2">
                                <button onClick={() => sheets.length ? downloadCSV(generateMasterCSV(sheets.filter(s => !s.archived)), `Master_Report_${new Date().toISOString().split('T')[0]}.csv`) : alert('No records')} className="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded"><FileSpreadsheet size={14} className="mr-2" /> Export All Data</button>
                                <div className="text-center text-xs text-gray-500">
                                    Total Records: {sheets.filter(s => !s.archived).length} | Archived: {sheets.filter(s => s.archived).length}
                                </div>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-grow flex flex-col h-screen overflow-hidden w-full">
                        <header className="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm print:hidden">
                            <div className="flex items-center">{!sidebarOpen && <button onClick={() => setSidebarOpen(true)} className="mr-4 text-gray-500"><Search size={20} /></button>}<h1 className="text-xl font-bold text-gray-800"><span className="text-blue-900 mr-2">PAMICOR</span> <span className="text-sm text-gray-600 font-normal">| Attendance System</span></h1></div>
                            <div className="flex items-center space-x-2">
                                <div className="hidden md:block mr-4 text-right">
                                    <div className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">System Time</div>
                                    <div className="text-sm font-mono font-bold text-gray-700">{adminTime.toLocaleTimeString('en-GB')}</div>
                                </div>
                                <button onClick={handleManualSave} className="flex items-center bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded transition-colors border border-blue-200 mr-2" title="Save Progress"><Save size={18} className="mr-2"/> <span className="hidden md:inline">Save</span></button>
                                <button onClick={() => setQrCodeOpen(true)} className="flex items-center bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-2 rounded transition-colors border border-purple-200 mr-2" title="System QR Code"><QrCode size={18} className="mr-2"/> <span className="hidden md:inline">System QR</span></button>
                                {activeSheet && <button onClick={() => downloadCSV(generateSheetCSV(activeSheet), `Attendance_${activeSheet.date}.csv`)} className="flex items-center text-gray-600 hover:text-green-600 px-3 py-2 rounded hover:bg-green-50"><Download size={18} className="mr-2"/> Export</button>}
                                <button onClick={() => window.print()} className="flex items-center text-gray-600 hover:text-blue-600 px-3 py-2 rounded hover:bg-blue-50"><Printer size={18} className="mr-2"/> Print</button>
                                <div className="h-6 w-px bg-gray-300 mx-2"></div>
                                <button onClick={() => { setView('login'); setCurrentUser(null); setActiveSheetId(null); }} className="flex items-center text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50"><LogOut size={18} /></button>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto bg-gray-100 p-4 md:p-8 print:p-0 print:bg-white">
                            {!activeSheet ? (
                                <div className="flex h-full flex-col items-center justify-center"><div className="text-center max-w-md"><div className="bg-blue-900 text-white p-4 rounded-full inline-block mb-4"><Briefcase size={48} /></div><h1 className="text-2xl font-bold text-gray-800 mb-2">Welcome, {currentUser}</h1><button onClick={createNewSheet} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">Start New Attendance Sheet</button></div></div>
                            ) : (
                                <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-none md:rounded-lg overflow-hidden print:shadow-none print:w-full">
                                    <div className="p-8 border-b-2 border-gray-800">
                                        
                                        {/* Official Header for Print */}
                                        <div className="hidden print:flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-800">
                                            <div className="w-1/3 text-left">
                                                <div className="font-bold text-lg text-blue-900">PAMICOR GHANA LTD</div>
                                                <div className="text-xs text-gray-500">Contracting & Engineering Services</div>
                                            </div>
                                            <div className="w-1/3 text-center">
                                                <div className="text-2xl font-black text-gray-900 uppercase tracking-widest">Attendance</div>
                                            </div>
                                            <div className="w-1/3 text-right">
                                                <div className="font-bold text-lg text-yellow-600">ANGLOGOLD ASHANTI</div>
                                                <div className="text-xs text-gray-500">Obuasi Mine Operations</div>
                                            </div>
                                        </div>

                                        <div className="text-center mb-6 print:hidden"><h2 className="text-2xl font-black text-gray-900 uppercase tracking-widest border-b-4 border-double border-gray-800 inline-block pb-1">Attendance Sheet</h2></div>
                                        <div className="flex justify-center space-x-8 mb-6 text-sm">{['Meeting', 'Training', 'Other'].map(type => (<label key={type} className="flex items-center cursor-pointer group"><div className={`w-5 h-5 border-2 flex items-center justify-center mr-2 ${activeSheet.type === type ? 'border-blue-600 bg-blue-600' : 'border-gray-400'}`}>{activeSheet.type === type && <CheckSquare size={14} className="text-white" />}</div><input type="radio" name="sheetType" checked={activeSheet.type === type} onChange={() => updateSheet(activeSheet.id, 'type', type)} className="hidden" /><span className={`font-semibold uppercase ${activeSheet.type === type ? 'text-blue-800' : 'text-gray-600'}`}>{type}</span></label>))}</div>
                                        
                                        <div className="grid grid-cols-12 gap-0 border-2 border-gray-800">
                                            {/* Session Timeline Selector */}
                                            <div className="col-span-12 bg-blue-50 p-2 border-b border-gray-400 flex items-center justify-center space-x-4 print:hidden">
                                                <span className="text-xs font-bold text-blue-800 uppercase mr-2">Select Timeline:</span>
                                                {Object.keys(TIMELINES).map(t => (
                                                    <button 
                                                        key={t}
                                                        onClick={() => updateSheet(activeSheet.id, 'session', t)}
                                                        className={`text-xs font-bold px-3 py-1 rounded-full flex items-center transition-colors ${activeSheet.session === t ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100'}`}
                                                    >
                                                        {TIMELINES[t].icon} {t}
                                                    </button>
                                                ))}
                                            </div>

                                            <div className="col-span-3 bg-gray-100 p-3 border-b border-r border-gray-400 text-sm font-bold uppercase flex items-center">Meeting Name:</div>
                                            <div className="col-span-9 p-0 border-b border-gray-400"><input type="text" value={activeSheet.meetingName} onChange={(e) => updateSheet(activeSheet.id, 'meetingName', e.target.value)} placeholder="e.g. Weekly HSE Meeting" className="w-full h-full p-3 text-sm font-medium focus:outline-none focus:bg-blue-50" /></div>
                                            
                                            <div className="col-span-3 bg-gray-100 p-3 border-b border-r border-gray-400 text-sm font-bold uppercase flex items-center">Topic / Subject:</div>
                                            <div className="col-span-9 p-0 border-b border-gray-400"><input type="text" value={activeSheet.topic} onChange={(e) => updateSheet(activeSheet.id, 'topic', e.target.value)} placeholder="Specific topic..." className="w-full h-full p-3 text-sm font-medium focus:outline-none focus:bg-blue-50" /></div>

                                            <div className="col-span-3 md:col-span-2 bg-gray-100 p-3 border-b border-r border-gray-400 text-sm font-bold uppercase flex items-center">Date:</div>
                                            <div className="col-span-9 md:col-span-4 p-0 border-b md:border-r border-gray-400"><input type="date" value={activeSheet.date} onChange={(e) => updateSheet(activeSheet.id, 'date', e.target.value)} className="w-full h-full p-3 text-sm focus:outline-none focus:bg-blue-50" /></div>
                                            
                                            <div className="col-span-12 md:col-span-6 grid grid-cols-3 border-b border-gray-400">
                                                <div className="border-r border-gray-400 p-2 relative flex flex-col justify-center">
                                                    <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">Start</div>
                                                    <div className="relative w-full"><input type="time" step="300" onWheel={(e) => e.target.blur()} value={activeSheet.startTime} onChange={(e) => updateSheet(activeSheet.id, 'startTime', e.target.value)} className="w-full text-sm font-mono focus:outline-none bg-transparent relative z-10" /><ChevronDown size={14} className="absolute right-0 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" /></div>
                                                </div>
                                                <div className="border-r border-gray-400 p-2 relative flex flex-col justify-center">
                                                    <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">End</div>
                                                    <div className="relative w-full"><input type="time" step="300" onWheel={(e) => e.target.blur()} value={activeSheet.endTime} onChange={(e) => updateSheet(activeSheet.id, 'endTime', e.target.value)} className="w-full text-sm font-mono focus:outline-none bg-transparent relative z-10" /><ChevronDown size={14} className="absolute right-0 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" /></div>
                                                </div>
                                                <div className="p-2 bg-blue-50 flex flex-col justify-center">
                                                    <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">Duration</div>
                                                    <input type="text" value={activeSheet.duration} onChange={(e) => updateSheet(activeSheet.id, 'duration', e.target.value)} className="w-full text-sm font-bold text-blue-800 bg-transparent outline-none" />
                                                </div>
                                            </div>

                                            <div className="col-span-3 bg-gray-100 p-3 border-b border-r border-gray-400 text-sm font-bold uppercase flex items-center">Site & Venue:</div>
                                            <div className="col-span-9 p-0 border-b border-gray-400"><input type="text" value={activeSheet.site} onChange={(e) => updateSheet(activeSheet.id, 'site', e.target.value)} className="w-full h-full p-3 text-sm focus:outline-none focus:bg-blue-50" /></div>

                                            <div className="col-span-3 bg-gray-100 p-3 border-r border-gray-400 text-sm font-bold uppercase flex items-center">Conducted By:</div>
                                            <div className="col-span-5 p-0 border-r border-gray-400"><input type="text" value={activeSheet.conductedBy} onChange={(e) => updateSheet(activeSheet.id, 'conductedBy', e.target.value)} className="w-full h-full p-3 text-sm focus:outline-none focus:bg-blue-50" /></div>
                                            <div className="col-span-1 bg-gray-100 p-3 border-r border-gray-400 text-xs font-bold uppercase flex items-center justify-center">Sign:</div>
                                            <div className="col-span-3 p-0 flex items-center justify-center bg-white cursor-pointer hover:bg-gray-50" onClick={() => setSigningState({ isOpen: true, type: 'conductor' })}>
                                                {activeSheet.conductorSignature ? <div className="flex flex-col items-center"><img src={activeSheet.conductorSignature} className="h-8" /><span className="text-[6px] text-gray-400">{activeSheet.conductorSignTime}</span></div> : <div className="text-xs text-gray-300 hover:text-blue-500 flex items-center"><PenTool size={12} className="mr-1"/> Sign</div>}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="p-8 pt-4">
                                        <div className="mb-4 flex justify-between items-center print:hidden">
                                            <div className="flex items-center space-x-4">
                                                <h3 className="font-bold text-gray-700">Attendees</h3>
                                                <div className="flex space-x-2 text-xs">
                                                    <span className="bg-blue-50 text-blue-700 px-2 py-1 rounded">Total: {stats.total}</span>
                                                    <span className="bg-green-50 text-green-700 px-2 py-1 rounded">Signed: {stats.signed}</span>
                                                    {stats.late > 0 && <span className="bg-red-50 text-red-700 px-2 py-1 rounded">Late: {stats.late}</span>}
                                                </div>
                                            </div>
                                            <button onClick={() => setQuickAddOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded shadow-sm flex items-center"><Users size={14} className="mr-1"/> Quick Add / Import</button>
                                        </div>
                                        
                                        <table className="w-full border-collapse border-2 border-gray-800 text-sm">
                                            <thead><tr className="bg-gray-100"><th className="border border-gray-600 p-3 w-12">No.</th><th className="border border-gray-600 p-3 text-left w-64">Name</th><th className="border border-gray-600 p-3 text-left w-32">Company</th><th className="border border-gray-600 p-3 text-left w-40">Job Title</th><th className="border border-gray-600 p-3 w-40">Signature</th><th className="border border-gray-600 p-3 w-10 print:hidden"></th></tr></thead>
                                            <tbody>
                                                {activeSheet.attendees.map((att, i) => {
                                                    const isLate = checkIsLate(att.signTime, activeSheet.startTime);
                                                    return (
                                                    <tr key={att.id} className="hover:bg-blue-50">
                                                        <td className="border border-gray-400 p-3 text-center text-gray-500">{i + 1}</td>
                                                        <td className="border border-gray-400 p-0"><input type="text" value={att.name} onChange={(e) => updateAttendee(activeSheet.id, att.id, 'name', e.target.value)} className="w-full h-full p-3 bg-transparent outline-none" placeholder="Name" /></td>
                                                        
                                                        {/* Admin Company Dropdown */}
                                                        <td className="border border-gray-400 p-0">
                                                            <div className="relative h-full w-full">
                                                                <select value={att.company} onChange={(e) => updateAttendee(activeSheet.id, att.id, 'company', e.target.value)} className="w-full h-full p-3 bg-transparent outline-none appearance-none cursor-pointer">
                                                                    <option value="">Select...</option>
                                                                    {COMPANY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                                                </select>
                                                            </div>
                                                        </td>

                                                        {/* Admin Job Title Dropdown */}
                                                        <td className="border border-gray-400 p-0">
                                                            <div className="relative h-full w-full">
                                                                <select value={att.jobTitle} onChange={(e) => updateAttendee(activeSheet.id, att.id, 'jobTitle', e.target.value)} className="w-full h-full p-3 bg-transparent outline-none appearance-none cursor-pointer">
                                                                    <option value="">Select...</option>
                                                                    {JOB_TITLE_OPTIONS.map(j => <option key={j} value={j}>{j}</option>)}
                                                                </select>
                                                            </div>
                                                        </td>

                                                        <td className="border border-gray-400 p-1 text-center cursor-pointer" onClick={() => setSigningState({ isOpen: true, type: 'attendee', attendeeId: att.id })}>
                                                            {att.signature ? 
                                                                <div className="flex flex-col items-center group relative">
                                                                    <img src={att.signature} className="h-8" />
                                                                    <div className="flex items-center mt-1">
                                                                        <span className="text-[6px] text-gray-400">{att.signTime}</span>
                                                                        {isLate && <span className="ml-1 text-[6px] font-bold text-white bg-red-500 px-1 rounded">LATE</span>}
                                                                    </div>
                                                                    <button onClick={(e) => { e.stopPropagation(); clearSignature(activeSheet.id, att.id); }} className="absolute -top-1 -right-1 bg-red-100 text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Clear Signature"><RotateCcw size={10}/></button>
                                                                </div> 
                                                                : <div className="text-xs text-gray-300 hover:text-blue-500 flex items-center justify-center h-10 bg-gray-50 rounded"><PenTool size={12} className="mr-1"/> Sign</div>
                                                            }
                                                        </td>
                                                        <td className="border border-gray-400 p-1 text-center print:hidden"><button onClick={() => setSheets(sheets.map(s => s.id !== activeSheet.id ? s : { ...s, attendees: s.attendees.filter(a => a.id !== att.id) }))} className="text-gray-300 hover:text-red-500"><Trash2 size={14} /></button></td>
                                                    </tr>
                                                )})}
                                            </tbody>
                                        </table>
                                        <div className="mt-2 flex justify-center print:hidden"><button onClick={() => setSheets(sheets.map(s => s.id !== activeSheet.id ? s : { ...s, attendees: [...s.attendees, { id: generateId(), name: '', company: 'Pamicor', jobTitle: '', signature: null, signTime: null }] }))} className="flex items-center text-gray-500 hover:text-blue-600 text-sm font-medium px-4 py-2 hover:bg-gray-100 rounded"><Plus size={16} className="mr-1" /> Add Single Row</button></div>
                                    </div>

                                    <div className="px-8 pb-8"><div className="border-2 border-gray-800 rounded-sm"><div className="bg-gray-100 border-b border-gray-400 p-2 text-xs font-bold uppercase text-gray-700">Safety Shares / Concerns / Remarks / Minutes:</div><textarea value={activeSheet.minutes} onChange={(e) => updateSheet(activeSheet.id, 'minutes', e.target.value)} className="w-full p-4 text-sm h-48 focus:outline-none resize-y" placeholder="Type meeting minutes..." /></div></div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<PamicorAttendanceSystem />);
    </script>
</body>
</html>